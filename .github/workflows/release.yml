name: Create New Release

on:
  push:
    branches:
      - main

jobs:
  create_release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'
        
    - name: Install dependencies
      run: npm install
      
    - name: Get the latest release version
      id: get_latest_version
      run: |
        LAST_VERSION=$(git tag -l 'V*' --sort=-v:refname | head -n 1)
        if [ -z "$LAST_VERSION" ]; then
          LAST_VERSION="V0"
        fi
        echo "LAST_VERSION=$LAST_VERSION" >> $GITHUB_ENV
        
    - name: Increment the release version
      id: increment_version
      run: |
        PREVIOUS_VERSION=$LAST_VERSION
        LAST_VERSION="V$(( ${PREVIOUS_VERSION#"V"} + 1 ))"
        echo "LAST_VERSION=$LAST_VERSION" >> $GITHUB_ENV
        
    - name: Create release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.increment_version.outputs.LAST_VERSION }}
        release_name: ${{ steps.increment_version.outputs.LAST_VERSION }}
        draft: false
        prerelease: false
        commitish: ${{ github.sha }}
